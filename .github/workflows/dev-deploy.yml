name: Docker Image CI

on:
  push:
    branches: [ "main"]
  pull_request:
    branches: [ "main" ]

jobs:
  build_backend:
    runs-on: ubuntu-latest  

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build Backend Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/mybackend2:latest -f Dockerfile_backend .
      working-directory: ./Backend  #1233

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Backend Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/mybackend2:latest

  build_frontend:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Build Frontend Docker Image
      run: |
        docker build -t ${{ secrets.DOCKER_USERNAME }}/myfrontend:latest -f Dockerfile_frontend .
      working-directory: ./Frontend  

    - name: Login to DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Push Frontend Docker Image
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/myfrontend:latest

  deploy_to_ec2:
    runs-on: ubuntu-latest

    needs: [build_backend, build_frontend]

    steps:
    - name: SSH into EC2 Instance and Pull Docker Image
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_INSTANCE_IP }}
        username: ec2-user
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          sudo docker stop backend-container
          sudo docker rm backend-container
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/mybackend2:latest
          sudo docker run -d -p 8081:8081 --name backend-container ${{ secrets.DOCKER_USERNAME }}/mybackend2:latest

          sudo docker stop frontend-container
          sudo docker rm frontend-container
          sudo docker pull ${{ secrets.DOCKER_USERNAME }}/myfrontend:latest
          sudo docker run -d -p 3000:3000 --restart always --name frontend-container ${{ secrets.DOCKER_USERNAME }}/myfrontend:latest
